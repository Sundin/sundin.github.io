<!doctype html><html class=no-js lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><title>Analytics without third-party tools - Master of Software Engineering</title><script>(function(a,b){a[b]=a[b].replace("no-js","js")})(document.documentElement,"className")</script><meta name=description content><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=dns-prefetch href=//fonts.googleapis.com><link rel=dns-prefetch href=//fonts.gstatic.com><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/favicon.ico></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class=logo><a class=logo__link href=/ title="Master of Software Engineering" rel=home><div class="logo__item logo__text"><div class=logo__title>Master of Software Engineering</div></div></a></div><div class=divider></div></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>Analytics without third-party tools</h1><div class="post__meta meta"><div class="meta__item-author meta__item"><svg class="meta__icon icon icon-author" width="16" height="16" viewBox="0 0 12 16"><path d="M6 1c2.2.0 3.5 2 3.5 4.5C9.5 7 8.9 8.2 8 9c2.9.8 4 2.5 4 5v1H0v-1c0-2.5 1.1-4.2 4-5-.9-.8-1.5-2-1.5-3.5C2.5 3 3.8 1 6 1z"/></svg><span class=meta__text>Gustav Sundin</span></div><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class=meta__text datetime=2020-09-01T00:00:00Z>2020-09-01</time></div><div class="meta__item-categories meta__item"><svg class="meta__icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2 1 2h8v11H0V2z"/></svg><span class=meta__text><a class=meta__link href=/categories/Implementation/ rel=category>Implementation</a></span></div></div></header><div class="content post__content clearfix"><p>Finding out how much traffic your site has and how your users interact with it is always crucial. Such information will enable you to scale your backend properly, fine-tune the user experience and weed out unused features. Some even go so far as claiming that data is the &ldquo;gold of our time&rdquo;. Regardless of the truth of that claim, few can dispute the usefulness of user analytics data.</p><p>The go-to solution for most developers is to use Google Analytics (in fact used by <a href=https://w3techs.com/technologies/details/ta-googleanalytics>55% of all websites</a>) or some other third party framework. Although this can surely be a valid choice and a quick way forward, using a third party tool to handle user analytics data raises some concerns. First of all, you give away data about how your product is being used for free (or perhaps you even pay for it!). And more importantly, it makes it harder for you to guarantee that potentially sensitive user data is handled in an anonymous and secure way. The best way to guarantee that your data is in safe hands is to let as few hands as possible get in touch with the data.</p><p>For the above reasons, you should at least consider implementing your own analytics tool. It turns out that it is actually much simpler than it sounds, at least as long as your use case is relatively simple (which it most probably is).</p><h2 id=implementation>Implementation</h2><p>As a proof of concept, we implemented a quick demonstration in React. The React application that we made will gather analytics data about the very same website that is used to display the gathered data. Disclaimer: the solution we came up with is heavily inspired by <a href=https://www.pcmaffey.com/roll-your-own-analytics/>a great blog post by P.C. Maffey</a>.</p><p>Live demo: <a href=http://devies-analytics-poc.s3-website-eu-west-1.amazonaws.com/>http://devies-analytics-poc.s3-website-eu-west-1.amazonaws.com/</a></p><p>Source code: <a href=https://github.com/DeviesDevelopment/analytics-poc>https://github.com/DeviesDevelopment/analytics-poc</a></p><h3 id=overview>Overview</h3><p>The data we are interested in is to count the number of <strong>sessions</strong> on our website. For each session we are also interested in knowing which pages were visited, in which order and how long the user stayed on each page. A session therefore consists of a number of <strong>events</strong>, where every page change is considered a new event. We decided to only store non-sensitive user data, meaning no IP addresses or other data that can be used to identify the user behind a specific session. We also decided not to use any cookies in the user&rsquo;s browser to detect whether it&rsquo;s a new or returning visitor.</p><h3 id=how-it-works>How it works</h3><p>Every time the path changes, an event is stored in the <a href=https://github.com/DeviesDevelopment/analytics-poc/blob/master/frontend/src/Analytics.jsx>Analytics.jsx</a> component. When the browser session ends, all the collected events are sent (together with some metadata) in a single request to a lambda endpoint. The lambda then parses the data and saves it to a DynamoDB table. This means that for every user session, only a single request is sent to the analytics endpoint, making this approach very lightweight.</p><h3 id=detecting-path-changes>Detecting path changes</h3><p>To detect when the path changes, we have added a component (<a href=https://github.com/DeviesDevelopment/analytics-poc/blob/master/frontend/src/Analytics.jsx>Analytics.jsx</a>) to track it on the top-level in our DOM. The component doesn&rsquo;t render anything, but leverages the following React hook to detect path changes:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-jsx data-lang=jsx><span style=color:#a6e22e>React</span>.<span style=color:#a6e22e>useEffect</span>(() =&gt; {
  <span style=color:#a6e22e>pushEvent</span>({
    <span style=color:#a6e22e>pathname</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>location</span>.<span style=color:#a6e22e>pathname</span>,
    <span style=color:#a6e22e>timestamp</span><span style=color:#f92672>:</span> Date.<span style=color:#a6e22e>now</span>(),
  });
  <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#34;Location changed&#34;</span>, <span style=color:#a6e22e>location</span>.<span style=color:#a6e22e>pathname</span>);
}, [<span style=color:#a6e22e>location</span>]);
</code></pre></div><p>The events are best stored as a simple array in the state of the component. You can also use Redux if you prefer, or store it using a <a href=https://reactjs.org/docs/refs-and-the-dom.html>ref</a> in a stateless component.</p><h3 id=sending-data-to-the-backend>Sending data to the backend</h3><p>To detect when the browser session ends, we have set up various event listeners:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript>window.<span style=color:#a6e22e>addEventListener</span>(<span style=color:#e6db74>&#34;pagehide&#34;</span>, <span style=color:#a6e22e>endSession</span>);
window.<span style=color:#a6e22e>addEventListener</span>(<span style=color:#e6db74>&#34;beforeunload&#34;</span>, <span style=color:#a6e22e>endSession</span>);
window.<span style=color:#a6e22e>addEventListener</span>(<span style=color:#e6db74>&#34;unload&#34;</span>, <span style=color:#a6e22e>endSession</span>);
</code></pre></div><p>The <code>endSession()</code> function in turn sends a <a href=https://developer.mozilla.org/en-US/docs/Web/API/Navigator/sendBeacon>beacon</a> with the collected data to the backend (a beacon is a request that is sent asynchronously and that will finish in the background even if the browser session is terminated).</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript>window.<span style=color:#a6e22e>navigator</span>.<span style=color:#a6e22e>sendBeacon</span>(<span style=color:#a6e22e>url</span>, <span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>stringify</span>(<span style=color:#a6e22e>data</span>));
</code></pre></div><p>Some workarounds have had to be added to handle various browsers as well, see <a href=https://www.pcmaffey.com/roll-your-own-analytics/>the original post</a> for more details.</p><h3 id=backend>Backend</h3><p>Our backend is hosted on AWS and set up using CloudFormation and AWS SAM. It is very minimal, containing only an API Gateway as interface, a DynamoDB database for storing the gathered user analytics data and two lambda functions; one for saving data and one for retrieving data. You can browse the template file <a href=https://github.com/DeviesDevelopment/analytics-poc/blob/master/backend/template.yml>here</a>.</p><h2 id=next-steps>Next steps</h2><p>First of all, you should consider what it is that you really want to know about how people use your product. Just collecting data for the sake of it is pretty pointless. That being said, here are some ideas for how this POC could be expanded:</p><ul><li>Gather other types of events other than just path changes. Such as: buttons clicked, external link opened.</li><li>Improve UI for browsing data.</li><li>Aggregate other kinds of metrics. See <a href=https://en.wikipedia.org/wiki/Web_analytics#On-site_web_analytics_-_definitions>this list on Wikipedia</a> for some inspiration.</li><li>Different browsers sometimes behaves very differently, so more work is needed to make sure we handle all possible combinations of devices and browsers properly.</li><li>If you use some other implementation than React, this solution should be straightforward to reuse. Here is <a href=https://github.com/Sundin/armory-online/blob/master/src/components/Analytics.vue>an implementation in Vue</a>.</li><li>Implement some check to filter out bots and scrapers, as you are probably only interested in the behaviour of real human users.</li></ul><h2 id=takeaways>Takeaways</h2><p>User behaviour analytics can be collected anonymously without the need for any big tool or framework. The upside of this approach is that you don&rsquo;t need to bloat down your application with any heavy third-party dependencies, and also that you will maintain control of your users' data. The only downside is of course that you need to implement the interface for aggregating and displaying the collected data yourself.</p><p>While this proof-of-concept shows that is relatively easy to set up your own analytics infrastructure, there are probably countless number of corner cases that we did not consider. In a real-life production application, the golden middle way would therefore probably be to choose a self-hosted, open-source analytics tool instead. That way you stay in control of the data, while still not having to fix all the bugs on your own. Some of the alternatives include <a href=http://www.openwebanalytics.com/>Open Web Analytics</a>, <a href=https://matomo.org/matomo-on-premise/>Matomo</a>, <a href=https://count.ly/community-edition>Countly</a> and <a href=https://plausible.io/self-hosted-web-analytics>Plausible</a>.</p><h2 id=references>References</h2><ul><li><p>The original idea and some of the implementation taken from <a href=https://www.pcmaffey.com/roll-your-own-analytics/>this blog post</a>.</p></li><li><p>The <a href=https://en.wikipedia.org/wiki/Web_analytics>Wikipedia article on web analytics</a> contains much background information about this topic.</p></li></ul></div></article></main><div class="authorbox clearfix"><div class=authorbox__header><span class=authorbox__name>About Gustav Sundin</span></div><div class=authorbox__description>My name is Gustav Sundin and I currently work as software engineering consultant at Devies in Gothenburg, Sweden. I also hold a Master’s degree in Software Engineering from Chalmers University. A cool thing with that is that I am allowed to titulate myself “Master of Software Engineering”!</div><br>Follow me with <b><a href=/feed.xml>RSS</a></b>.</br><br><i>Did I make a mistake? Please feel free to <b><a href=https://github.com/Sundin/sundin.github.io>issue a pull request to my Github repo</a></b>.</i></br></div><nav class="pager flex"><div class="pager__item pager__item--prev"><a class=pager__link href=/Breaking-Synchronous-Dependencies/ rel=prev><span class=pager__subtitle>«&#8201;Previous</span><p class=pager__title>Breaking Synchronous Dependencies</p></a></div><div class="pager__item pager__item--next"><a class=pager__link href=/How-I-Read-a-Book/ rel=next><span class=pager__subtitle>Next&#8201;»</span><p class=pager__title>How I Read a Book</p></a></div></nav></div><aside class=sidebar><div class="widget-recent widget"><h4 class=widget__title>Recent Posts</h4><div class=widget__content><ul class=widget__list><li class=widget__item><a class=widget__link href=/dotnet-audit-logs/>Automatic Audit Logs in .NET</a></li><li class=widget__item><a class=widget__link href=/nginx-reverse-proxy/>How to Build a Reverse Proxy</a></li><li class=widget__item><a class=widget__link href=/the-weirdest-error/>The Weirdest Error</a></li><li class=widget__item><a class=widget__link href=/code-review-reflections/>Code Review Reflections</a></li><li class=widget__item><a class=widget__link href=/kubernetes-tutorial/>A short Kubernetes tutorial</a></li></ul></div></div><div class="widget-categories widget"><h4 class=widget__title>Categories</h4><div class=widget__content><ul class=widget__list><li class=widget__item><a class=widget__link href=/categories/Agile/>Agile</a>&nbsp;
<span class="widget__counter widget__counter--bubble">4</span></li><li class=widget__item><a class=widget__link href=/categories/Architecture/>Architecture</a>&nbsp;
<span class="widget__counter widget__counter--bubble">1</span></li><li class=widget__item><a class=widget__link href=/categories/Implementation/>Implementation</a>&nbsp;
<span class="widget__counter widget__counter--bubble">6</span></li><li class=widget__item><a class=widget__link href=/categories/Learning/>Learning</a>&nbsp;
<span class="widget__counter widget__counter--bubble">2</span></li><li class=widget__item><a class=widget__link href=/categories/Mindset/>Mindset</a>&nbsp;
<span class="widget__counter widget__counter--bubble">3</span></li><li class=widget__item><a class=widget__link href=/categories/Patterns/>Patterns</a>&nbsp;
<span class="widget__counter widget__counter--bubble">2</span></li><li class=widget__item><a class=widget__link href=/categories/Refactoring/>Refactoring</a>&nbsp;
<span class="widget__counter widget__counter--bubble">3</span></li><li class=widget__item><a class=widget__link href=/categories/Testing/>Testing</a>&nbsp;
<span class="widget__counter widget__counter--bubble">3</span></li><li class=widget__item><a class=widget__link href=/categories/Tutorial/>Tutorial</a>&nbsp;
<span class="widget__counter widget__counter--bubble">3</span></li><li class=widget__item><a class=widget__link href=/categories/Workflow/>Workflow</a>&nbsp;
<span class="widget__counter widget__counter--bubble">2</span></li></ul></div></div><div class="widget-taglist widget"><h4 class=widget__title>Tags</h4><div class=widget__content><a class="widget-taglist__link widget__link btn" href=/tags/.NET/ title=.NET>.NET</a>
<a class="widget-taglist__link widget__link btn" href=/tags/AWS/ title=AWS>AWS</a>
<a class="widget-taglist__link widget__link btn" href=/tags/DNS/ title=DNS>DNS</a>
<a class="widget-taglist__link widget__link btn" href=/tags/Docker/ title=Docker>Docker</a>
<a class="widget-taglist__link widget__link btn" href=/tags/DynamoDB/ title=DynamoDB>DynamoDB</a>
<a class="widget-taglist__link widget__link btn" href=/tags/Java/ title=Java>Java</a>
<a class="widget-taglist__link widget__link btn" href=/tags/Kubernetes/ title=Kubernetes>Kubernetes</a>
<a class="widget-taglist__link widget__link btn" href=/tags/PHP/ title=PHP>PHP</a></div></div><div class="widget-social widget"><h4 class="widget-social__title widget__title">Social</h4><div class="widget-social__content widget__content"><div class="widget-social__item widget__item"><a class="widget-social__link widget__link btn" title=GitHub rel="noopener noreferrer" href=https://github.com/Sundin target=_blank><svg class="widget-social__link-icon icon icon-github" width="24" height="24" viewBox="0 0 384 374"><path d="m192 0C85.9.0.0 85.8.0 191.7c0 84.7 55 156.6 131.3 181.9 9.6 1.8 13.1-4.2 13.1-9.2.0-4.6-.2-16.6-.3-32.6-53.4 11.6-64.7-25.7-64.7-25.7-8.7-22.1-21.3-28-21.3-28-17.4-11.9 1.3-11.6 1.3-11.6 19.3 1.4 29.4 19.8 29.4 19.8 17.1 29.3 44.9 20.8 55.9 15.9 1.7-12.4 6.7-20.8 12.2-25.6-42.6-4.8-87.5-21.3-87.5-94.8.0-20.9 7.5-38 19.8-51.4-2-4.9-8.6-24.3 1.9-50.7.0.0 16.1-5.2 52.8 19.7 15.3-4.2 31.7-6.4 48.1-6.5 16.3.1 32.7 2.2 48.1 6.5 36.7-24.8 52.8-19.7 52.8-19.7 10.5 26.4 3.9 45.9 1.9 50.7 12.3 13.4 19.7 30.5 19.7 51.4.0 73.7-44.9 89.9-87.7 94.6 6.9 5.9 13 17.6 13 35.5.0 25.6-.2 46.3-.2 52.6.0 5.1 3.5 11.1 13.2 9.2C329 348.2 384 276.4 384 191.7 384 85.8 298 0 192 0z"/></svg><span>GitHub</span></a></div><div class="widget-social__item widget__item"><a class="widget-social__link widget__link btn" title=Email href=mailto:gustav@devies.se><svg class="widget-social__link-icon icon icon-mail" width="24" height="24" viewBox="0 0 416 288"><path d="m0 16v256 16h16 384 16v-16V16 0h-16H16 0zm347 16-139 92.5L69 32zM199 157.5l9 5.5 9-5.5L384 46v210H32V46z"/></svg><span>gustav@devies.se</span></a></div><div class="widget-social__item widget__item"><a class="widget-social__link widget__link btn" title="Stack Overflow" rel="noopener noreferrer" href=https://stackoverflow.com/users/948942/incinerator target=_blank><svg class="widget-social__link-icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2 1 2h8v11H0V2z"/></svg><span>Stack Overflow</span></a></div><div class="widget-social__item widget__item"><a class="widget-social__link widget__link btn" title="About Me" rel="noopener noreferrer" href=/welcome target=_blank><svg class="widget-social__link-icon icon icon-author" width="16" height="16" viewBox="0 0 12 16"><path d="M6 1c2.2.0 3.5 2 3.5 4.5C9.5 7 8.9 8.2 8 9c2.9.8 4 2.5 4 5v1H0v-1c0-2.5 1.1-4.2 4-5-.9-.8-1.5-2-1.5-3.5C2.5 3 3.8 1 6 1z"/></svg><span>About Me</span></a></div></div></div></aside></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2021 Gustav Sundin.
<span class=footer__copyright-credits>Generated with <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> and <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> theme.</span></div></div></footer></div><script async defer src=/js/menu.js></script></body></html>