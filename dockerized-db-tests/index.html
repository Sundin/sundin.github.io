<!doctype html><html class=no-js lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><title>Dockerized database testing - Master of Software Engineering</title><script>(function(a,b){a[b]=a[b].replace("no-js","js")})(document.documentElement,"className")</script><meta name=description content><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=dns-prefetch href=//fonts.googleapis.com><link rel=dns-prefetch href=//fonts.gstatic.com><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/favicon.ico></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class=logo><a class=logo__link href=/ title="Master of Software Engineering" rel=home><div class="logo__item logo__text"><div class=logo__title>Master of Software Engineering</div></div></a></div><div class=divider></div></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>Dockerized database testing</h1><div class="post__meta meta"><div class="meta__item-author meta__item"><svg class="meta__icon icon icon-author" width="16" height="16" viewBox="0 0 12 16"><path d="M6 1c2.2.0 3.5 2 3.5 4.5C9.5 7 8.9 8.2 8 9c2.9.8 4 2.5 4 5v1H0v-1c0-2.5 1.1-4.2 4-5-.9-.8-1.5-2-1.5-3.5C2.5 3 3.8 1 6 1z"/></svg><span class=meta__text>Gustav Sundin</span></div><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class=meta__text datetime=2019-03-29T11:11:30Z>2019-03-29</time></div><div class="meta__item-categories meta__item"><svg class="meta__icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2 1 2h8v11H0V2z"/></svg><span class=meta__text><a class=meta__link href=/categories/Testing/ rel=category>Testing</a></span></div></div></header><div class="content post__content clearfix"><p>In this post I am going to give you an overview of different approaches to use when unit testing your backend code and database calls.</p><h2 id=background>Background</h2><p>In my current project, we have a backend written in <a href=https://golang.org/>Go</a> and a <a href=https://www.postgresql.org/>PostgreSQL</a> database. We have for a long time been writing unit tests for the backend to be able to guarantee that the code is working as intended. In order to not have to rely on a database connection and be dependent on the state of the data in that database, we chose to mock away all database calls using a tool called <a href=https://github.com/DATA-DOG/go-sqlmock>go-sqlmock</a> in the unit tests.</p><p>The benefits of mocking away database calls are that the unit tests will be lightning fast to run and, more importantly, that we are guaranteed to get a reproducible environment on every test run. This approach that has helped us to catch a large number of bugs, so it was time really well invested.</p><p>However, mocking away the database means that there are some types of problems that we are unable to catch with the unit tests. These potential problems include:</p><ul><li>Faulty SQL syntax in queries.</li><li>Queries returning wrong data.</li><li>Database triggers not working as intended.</li><li>Broken migrations (faulty syntax or not being possible to roll back).</li></ul><p>In order to catch these kinds of problems we have to run some kind of tests against a real database. One of our early attempts included connecting to a &ldquo;hands-off&rdquo; database instance where no one had manual access. This worked fine as long as our tests were limited to just reading data from the database, but as soon as we had to start manipulating the data during our tests we started to run into problems. Since each test run would start from a different state than the previous run, we could no longer guarantee that each test run would give the same result. This is a huge problem, since the <a href=https://www.martinfowler.com/articles/nonDeterminism.html>tests need to be deterministic</a> if we are to trust them and be able to integrate them into our automated delivery pipeline.</p><p>This severe drawback led us to where we are now: firing up a new database instance using <a href=https://www.docker.com/>Docker</a> for each run of the test suite.</p><h2 id=docker-to-the-rescue>Docker to the rescue</h2><p>I have chosen not to include any source code in this blog post (that might be the topic for another post if you are interested), but the high-level flow of our database tests looks something like this:</p><ol><li>Launch a <a href=https://docs.docker.com/samples/library/postgres/>PostgreSQL Docker container</a>.</li><li>Validate and run migration files. Here we have the chance to not only validate that the syntax in our migrations is correct, but also that the &ldquo;up&rdquo; and &ldquo;down&rdquo; parts of the migration actually mirror each other.</li><li>Populate database with a pre-defined set of data. Since we know what data we put into the database, we can also be sure of what data our queries should return.</li><li>Run database tests. These are really the same thing as normal unit tests, but here we use a real database connection instead of a mocked one.</li></ol><h2 id=conclusion>Conclusion</h2><p>So does this approach replace the basic unit testing with mocked database calls? No! Both approaches are useful for different purposes. The idea is that we want to <a href=http://wiki.c2.com/?UnitTestIsolation>test different parts of our application in isolation</a>. The simple, mocked unit tests are useful for catching bugs in our Go code – if a unit test fails, we know that the problem is located somewhere in our backend code and not in the database. This type of tests are usually really fast to run as well, meaning that you can run them in between every code change. Correspondingly, the fully-fledged Docker tests are great to use for testing database logic in isolation and also for broader functional tests where we test the backend logic, the database logic, and the communication between the two.</p></div></article></main><div class="authorbox clearfix"><div class=authorbox__header><span class=authorbox__name>About Gustav Sundin</span></div><div class=authorbox__description>My name is Gustav Sundin and I currently work as software engineering consultant at Devies in Gothenburg, Sweden. I also hold a Master’s degree in Software Engineering from Chalmers University. A cool thing with that is that I am allowed to titulate myself “Master of Software Engineering”!</div><br>Follow me with <b><a href=/feed.xml>RSS</a></b>.</br><br><i>Did I make a mistake? Please feel free to <b><a href=https://github.com/Sundin/sundin.github.io>issue a pull request to my Github repo</a></b>.</i></br></div><nav class="pager flex"><div class="pager__item pager__item--prev"><a class=pager__link href=/Unix-Tools/ rel=prev><span class=pager__subtitle>«&#8201;Previous</span><p class=pager__title>Unix Tools</p></a></div><div class="pager__item pager__item--next"><a class=pager__link href=/successful-testing-strategy/ rel=next><span class=pager__subtitle>Next&#8201;»</span><p class=pager__title>A Successful Testing Strategy</p></a></div></nav></div><aside class=sidebar><div class="widget-recent widget"><h4 class=widget__title>Recent Posts</h4><div class=widget__content><ul class=widget__list><li class=widget__item><a class=widget__link href=/code-review-reflections/>Code Review Reflections</a></li><li class=widget__item><a class=widget__link href=/kubernetes-tutorial/>A short Kubernetes tutorial</a></li><li class=widget__item><a class=widget__link href=/patterns/refactoring/2021/04/12/avoid-else.html/>Avoid using else statements</a></li><li class=widget__item><a class=widget__link href=/implementation/aws/2021/04/08/minimize-java-lambda-coldstarts.html/>Minimize Java Lambda Cold Start Times</a></li><li class=widget__item><a class=widget__link href=/Migrating-data-between-DynamoDB-tables/>Migrating data between DynamoDB tables</a></li></ul></div></div><div class="widget-categories widget"><h4 class=widget__title>Categories</h4><div class=widget__content><ul class=widget__list><li class=widget__item><a class=widget__link href=/categories/AWS/>AWS</a>&nbsp;
<span class="widget__counter widget__counter--bubble">2</span></li><li class=widget__item><a class=widget__link href=/categories/Agility/>Agility</a>&nbsp;
<span class="widget__counter widget__counter--bubble">4</span></li><li class=widget__item><a class=widget__link href=/categories/Architecture/>Architecture</a>&nbsp;
<span class="widget__counter widget__counter--bubble">1</span></li><li class=widget__item><a class=widget__link href=/categories/DNS/>DNS</a>&nbsp;
<span class="widget__counter widget__counter--bubble">1</span></li><li class=widget__item><a class=widget__link href=/categories/Implementation/>Implementation</a>&nbsp;
<span class="widget__counter widget__counter--bubble">4</span></li><li class=widget__item><a class=widget__link href=/categories/Learning/>Learning</a>&nbsp;
<span class="widget__counter widget__counter--bubble">3</span></li><li class=widget__item><a class=widget__link href=/categories/Mindset/>Mindset</a>&nbsp;
<span class="widget__counter widget__counter--bubble">3</span></li><li class=widget__item><a class=widget__link href=/categories/Patterns/>Patterns</a>&nbsp;
<span class="widget__counter widget__counter--bubble">2</span></li><li class=widget__item><a class=widget__link href=/categories/Refactoring/>Refactoring</a>&nbsp;
<span class="widget__counter widget__counter--bubble">3</span></li><li class=widget__item><a class=widget__link href=/categories/Testing/>Testing</a>&nbsp;
<span class="widget__counter widget__counter--bubble">3</span></li><li class=widget__item><a class=widget__link href=/categories/Workflow/>Workflow</a>&nbsp;
<span class="widget__counter widget__counter--bubble">2</span></li></ul></div></div><div class="widget-social widget"><h4 class="widget-social__title widget__title">Social</h4><div class="widget-social__content widget__content"><div class="widget-social__item widget__item"><a class="widget-social__link widget__link btn" title=GitHub rel="noopener noreferrer" href=https://github.com/Sundin target=_blank><svg class="widget-social__link-icon icon icon-github" width="24" height="24" viewBox="0 0 384 374"><path d="m192 0C85.9.0.0 85.8.0 191.7c0 84.7 55 156.6 131.3 181.9 9.6 1.8 13.1-4.2 13.1-9.2.0-4.6-.2-16.6-.3-32.6-53.4 11.6-64.7-25.7-64.7-25.7-8.7-22.1-21.3-28-21.3-28-17.4-11.9 1.3-11.6 1.3-11.6 19.3 1.4 29.4 19.8 29.4 19.8 17.1 29.3 44.9 20.8 55.9 15.9 1.7-12.4 6.7-20.8 12.2-25.6-42.6-4.8-87.5-21.3-87.5-94.8.0-20.9 7.5-38 19.8-51.4-2-4.9-8.6-24.3 1.9-50.7.0.0 16.1-5.2 52.8 19.7 15.3-4.2 31.7-6.4 48.1-6.5 16.3.1 32.7 2.2 48.1 6.5 36.7-24.8 52.8-19.7 52.8-19.7 10.5 26.4 3.9 45.9 1.9 50.7 12.3 13.4 19.7 30.5 19.7 51.4.0 73.7-44.9 89.9-87.7 94.6 6.9 5.9 13 17.6 13 35.5.0 25.6-.2 46.3-.2 52.6.0 5.1 3.5 11.1 13.2 9.2C329 348.2 384 276.4 384 191.7 384 85.8 298 0 192 0z"/></svg><span>GitHub</span></a></div><div class="widget-social__item widget__item"><a class="widget-social__link widget__link btn" title=Email href=mailto:gustav@devies.se><svg class="widget-social__link-icon icon icon-mail" width="24" height="24" viewBox="0 0 416 288"><path d="m0 16v256 16h16 384 16v-16V16 0h-16H16 0zm347 16-139 92.5L69 32zM199 157.5l9 5.5 9-5.5L384 46v210H32V46z"/></svg><span>gustav@devies.se</span></a></div><div class="widget-social__item widget__item"><a class="widget-social__link widget__link btn" title="Stack Overflow" rel="noopener noreferrer" href=https://stackoverflow.com/users/948942/incinerator target=_blank><svg class="widget-social__link-icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2 1 2h8v11H0V2z"/></svg><span>Stack Overflow</span></a></div><div class="widget-social__item widget__item"><a class="widget-social__link widget__link btn" title="About Me" rel="noopener noreferrer" href=/welcome target=_blank><svg class="widget-social__link-icon icon icon-author" width="16" height="16" viewBox="0 0 12 16"><path d="M6 1c2.2.0 3.5 2 3.5 4.5C9.5 7 8.9 8.2 8 9c2.9.8 4 2.5 4 5v1H0v-1c0-2.5 1.1-4.2 4-5-.9-.8-1.5-2-1.5-3.5C2.5 3 3.8 1 6 1z"/></svg><span>About Me</span></a></div></div></div></aside></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2021 Gustav Sundin.
<span class=footer__copyright-credits>Generated with <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> and <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> theme.</span></div></div></footer></div><script async defer src=/js/menu.js></script></body></html>