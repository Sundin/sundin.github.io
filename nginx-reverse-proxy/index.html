<!doctype html><html class=no-js lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><title>How to build a reverse proxy - Master of Software Engineering</title><script>(function(e,t){e[t]=e[t].replace("no-js","js")})(document.documentElement,"className")</script><meta name=description content><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=dns-prefetch href=//fonts.googleapis.com><link rel=dns-prefetch href=//fonts.gstatic.com><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/favicon.ico></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class=logo><a class=logo__link href=/ title="Master of Software Engineering" rel=home><div class="logo__item logo__text"><div class=logo__title>Master of Software Engineering</div></div></a></div><div class=divider></div></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>How to build a reverse proxy</h1><div class="post__meta meta"><div class="meta__item-author meta__item"><svg class="meta__icon icon icon-author" width="16" height="16" viewBox="0 0 12 16"><path d="M6 1c2.2.0 3.5 2 3.5 4.5C9.5 7 8.9 8.2 8 9c2.9.8 4 2.5 4 5v1H0v-1c0-2.5 1.1-4.2 4-5-.9-.8-1.5-2-1.5-3.5C2.5 3 3.8 1 6 1z"/></svg><span class=meta__text>Gustav Sundin</span></div><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class=meta__text datetime=2021-06-28T10:58:32+02:00>2021-06-28</time></div><div class="meta__item-categories meta__item"><svg class="meta__icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2 1 2h8v11H0V2z"/></svg><span class=meta__text><a class=meta__link href=/categories/Tutorial/ rel=category>Tutorial</a>, <a class=meta__link href=/categories/Implementation/ rel=category>Implementation</a></span></div></div></header><div class="content post__content clearfix"><p>In this blog post I will describe how you can deploy services on the same server. The server will be fronted by an NGINX instance acting as a reverse proxy responsible for forwarding incoming traffic to the right service.</p><p>I will use an EC2 instance on AWS since it has a low monthly cost and I don&rsquo;t have to worry about hardware maintenance at all, but you can use the same approach for any kind of server. For real-life applications used in production it would probably be a really bad idea to deploy different services on the same EC2 instances, but for my own personal and hobby projects with very little traffic I&rsquo;m more interested in keeping costs down than building for resilience. In this scenario it makes perfect sense to deploy several of my projects to the same EC2 instance (or physical server, perhaps a Raspberry Pi at home). But how to make sure incoming traffic is routed to proper service on the server? This is where the reverse proxy comes in.</p><h2 id=preparations>Preparations</h2><p>First of all I launched an EC2 instance on my AWS account. I chose the Ubuntu 20.04 image, since it (as of writing this) able to use a newer version of Docker than the Amazon Linux AMI (Docker version 20.04 or newer is required for my approach to work).</p><p>You can also save yourself a bit of trouble by <a href=https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/elastic-ip-addresses-eip.html#using-instance-addressing-eips-allocating>allocating an elastic (=static) IP address</a> to your EC2 instance.</p><p>Now you can SSH to your EC2 instance and deploy all of your applications (I did it using separate Docker Compose stacks). You only need to make sure that each application/service runs on its own port.</p><h2 id=reverse-proxy>Reverse proxy</h2><p>Now that we have our applications up and running, we need to expose them to the outside world. We will do this by deploying an NGINX instance on port 80 (we will switch to HTTPS on port 443 in another blog post) which will act as a reverse proxy, redirecting incoming traffic to the right service.</p><p>Before we do that, we will first obtain some user-friendly URLs though. I used <a href=no-ip.com>no-ip.com</a> which is pretty nice. The free version is limited to 3 domain names which you have to renew every 30 days, but upgrading is pretty cheap at $25 per year. Create an account and create two different domains (<code>example1.zapto.org</code> and <code>example2.zapto.org</code> for the purposes of this tutorial) and route them to the elastic IP you assigned to your instance earlier.</p><p>Now we are ready to deploy our reverse proxy!</p><p>Create a file called <code>nginx.conf</code>. Remember to add your own domain names as <code>server_name</code> and also to replace the ports to the ones where your applications are actually running. You can also add additional <code>server</code> blocks if you have more than two applications up and running.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#66d9ef>events</span> {
</span></span><span style=display:flex><span>  <span style=color:#f92672>worker_connections</span>  <span style=color:#ae81ff>1024</span>;  <span style=color:#75715e># default is 1024, and this section is required
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>http</span> {
</span></span><span style=display:flex><span>  <span style=color:#f92672>resolver</span> <span style=color:#ae81ff>127</span><span style=color:#e6db74>.0.0.11</span> <span style=color:#e6db74>ipv6=off</span> <span style=color:#e6db74>valid=30s</span>; <span style=color:#75715e># This is Docker&#39;s static DNS IP
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>server</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>server_name</span>   <span style=color:#e6db74>example1.zapto.org</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>listen</span>       <span style=color:#ae81ff>80</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>location</span> <span style=color:#e6db74>/</span> {
</span></span><span style=display:flex><span>      <span style=color:#f92672>proxy_pass</span> <span style=color:#e6db74>http://host.docker.internal:8665/</span>;
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#75715e># Include this line so that your target service will see the original matching URL, not the proxied URL
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#f92672>proxy_set_header</span> <span style=color:#e6db74>Host</span> $host;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>server</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>server_name</span>   <span style=color:#e6db74>example2.zapto.org</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>listen</span>       <span style=color:#ae81ff>80</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>location</span> <span style=color:#e6db74>/</span> {
</span></span><span style=display:flex><span>      <span style=color:#f92672>proxy_pass</span> <span style=color:#e6db74>http://host.docker.internal:8080/</span>;
</span></span><span style=display:flex><span>      <span style=color:#f92672>proxy_set_header</span> <span style=color:#e6db74>Host</span> $host;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>And the following Dockerfile:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Docker data-lang=Docker><span style=display:flex><span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> nginx:1.21</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> nginx.conf /etc/nginx/nginx.conf<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>Now build the reverse proxy with</p><p><code>docker build -t reverse-proxy .</code></p><p>and start it with</p><p><code>docker run -d -p 80:80 --add-host host.docker.internal:host-gateway --name reverse-proxy reverse-proxy</code>.</p><p>(The <code>--add-host host.docker.internal:host-gateway</code> part means that we can use <code>host.docker.internal</code> as host in order to redirect traffic to <code>localhost</code> on our EC2 instance. This flag requires Docker version 20.04 or newer.)</p><h2 id=summary>Summary</h2><p>By just exposing a simple reverse proxy we can accept all incoming traffic on the same port. The reverse proxy will route the traffic to the right place by looking at the URL of the incoming request. By choosing NGINX and Docker we can also feel confident that this will work without eating up a lot of precious computing power on our server as well.</p></div><footer class=post__footer><div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5.0 11V3C0 1.5.8.8.8.8S1.5.0 3 0h8c1.5.0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 100-6 3 3 0 000 6z"/></svg><ul class=tags__list><li class=tags__item><a class="tags__link btn" href=/tags/Docker/ rel=tag>Docker</a></li><li class=tags__item><a class="tags__link btn" href=/tags/AWS/ rel=tag>AWS</a></li><li class=tags__item><a class="tags__link btn" href=/tags/NGINX/ rel=tag>NGINX</a></li></ul></div></footer></article></main><div class="authorbox clearfix"><div class=authorbox__header><span class=authorbox__name>About Gustav Sundin</span></div><div class=authorbox__description>My name is Gustav Sundin and I work full time as a creative and free spirit. I also hold a Master’s degree in Software Engineering from Chalmers University. A cool thing with that is that I am allowed to titulate myself “Master of Software Engineering”!</div><br>Follow me with <b><a href=/feed.xml>RSS</a></b>.</br><br><i>Did I make a mistake? Please feel free to <b><a href=https://github.com/Sundin/sundin.github.io>issue a pull request to my Github repo</a></b>.</i></br></div><nav class="pager flex"><div class="pager__item pager__item--prev"><a class=pager__link href=/dotnet-audit-logs/ rel=prev><span class=pager__subtitle>«&#8201;Previous</span><p class=pager__title>Automatic audit logs in .NET</p></a></div><div class="pager__item pager__item--next"><a class=pager__link href=/runtime-env-vars/ rel=next><span class=pager__subtitle>Next&#8201;»</span><p class=pager__title>Runtime environment variables in the browser</p></a></div></nav></div><aside class=sidebar><div class="widget-recent widget"><h4 class=widget__title>Featured Posts</h4><div class=widget__content><ul class=widget__list><li class=widget__item><a class=widget__link href=/sofware-engineer/>Learnings from working 6 years as a Software Engineer</a></li><li class=widget__item><a class=widget__link href=/sound-realms/>Introducing Sound Realms: Mace & Magic</a></li><li class=widget__item><a class=widget__link href=/e2e-tests-with-docker-compose/>Robust end-to-end testing with Docker Compose</a></li><li class=widget__item><a class=widget__link href=/runtime-env-vars/>Runtime environment variables in the browser</a></li><li class=widget__item><a class=widget__link href=/How-I-read-a-book/>How I read a book</a></li></ul></div></div><div class="widget-recent widget"><h4 class=widget__title>Recent Posts</h4><div class=widget__content><ul class=widget__list><li class=widget__item><a class=widget__link href=/keep-on-learning/>Keep on learning</a></li><li class=widget__item><a class=widget__link href=/sofware-engineer/>Learnings from working 6 years as a Software Engineer</a></li><li class=widget__item><a class=widget__link href=/e2e-testing-field-guide/>End-to-end testing field guide</a></li><li class=widget__item><a class=widget__link href=/flutter-custom-dialog/>Building a custom dialog in Flutter</a></li><li class=widget__item><a class=widget__link href=/sound-realms/>Introducing Sound Realms: Mace & Magic</a></li></ul></div></div><div class="widget-categories widget"><h4 class=widget__title>Categories</h4><div class=widget__content><ul class=widget__list><li class=widget__item><a class=widget__link href=/categories/Agile/>Agile</a>&nbsp;
<span class="widget__counter widget__counter--bubble">4</span></li><li class=widget__item><a class=widget__link href=/categories/Announcements/>Announcements</a>&nbsp;
<span class="widget__counter widget__counter--bubble">3</span></li><li class=widget__item><a class=widget__link href=/categories/Architecture/>Architecture</a>&nbsp;
<span class="widget__counter widget__counter--bubble">2</span></li><li class=widget__item><a class=widget__link href=/categories/Implementation/>Implementation</a>&nbsp;
<span class="widget__counter widget__counter--bubble">10</span></li><li class=widget__item><a class=widget__link href=/categories/Learning/>Learning</a>&nbsp;
<span class="widget__counter widget__counter--bubble">3</span></li><li class=widget__item><a class=widget__link href=/categories/Mindset/>Mindset</a>&nbsp;
<span class="widget__counter widget__counter--bubble">7</span></li><li class=widget__item><a class=widget__link href=/categories/Other/>Other</a>&nbsp;
<span class="widget__counter widget__counter--bubble">3</span></li><li class=widget__item><a class=widget__link href=/categories/Patterns/>Patterns</a>&nbsp;
<span class="widget__counter widget__counter--bubble">5</span></li><li class=widget__item><a class=widget__link href=/categories/Refactoring/>Refactoring</a>&nbsp;
<span class="widget__counter widget__counter--bubble">4</span></li><li class=widget__item><a class=widget__link href=/categories/Security/>Security</a>&nbsp;
<span class="widget__counter widget__counter--bubble">2</span></li><li class=widget__item><a class=widget__link href=/categories/Sound-Realms-Mace-Magic/>Sound Realms: Mace & Magic</a>&nbsp;
<span class="widget__counter widget__counter--bubble">2</span></li><li class=widget__item><a class=widget__link href=/categories/Testing/>Testing</a>&nbsp;
<span class="widget__counter widget__counter--bubble">5</span></li><li class=widget__item><a class=widget__link href=/categories/Tutorial/>Tutorial</a>&nbsp;
<span class="widget__counter widget__counter--bubble">10</span></li><li class=widget__item><a class=widget__link href=/categories/Workflow/>Workflow</a>&nbsp;
<span class="widget__counter widget__counter--bubble">5</span></li></ul></div></div><div class="widget-taglist widget"><h4 class=widget__title>Tags</h4><div class=widget__content><a class="widget-taglist__link widget__link btn" href=/tags/.NET/ title=.NET>.NET</a>
<a class="widget-taglist__link widget__link btn" href=/tags/AWS/ title=AWS>AWS</a>
<a class="widget-taglist__link widget__link btn" href=/tags/Cypress/ title=Cypress>Cypress</a>
<a class="widget-taglist__link widget__link btn" href=/tags/DNS/ title=DNS>DNS</a>
<a class="widget-taglist__link widget__link btn" href=/tags/Docker/ title=Docker>Docker</a>
<a class="widget-taglist__link widget__link btn" href=/tags/DynamoDB/ title=DynamoDB>DynamoDB</a>
<a class="widget-taglist__link widget__link btn" href=/tags/Flutter/ title=Flutter>Flutter</a>
<a class="widget-taglist__link widget__link btn" href=/tags/Java/ title=Java>Java</a>
<a class="widget-taglist__link widget__link btn" href=/tags/Kubernetes/ title=Kubernetes>Kubernetes</a>
<a class="widget-taglist__link widget__link btn" href=/tags/NGINX/ title=NGINX>NGINX</a>
<a class="widget-taglist__link widget__link btn" href=/tags/PHP/ title=PHP>PHP</a>
<a class="widget-taglist__link widget__link btn" href=/tags/Raspberry-Pi/ title="Raspberry Pi">Raspberry Pi</a>
<a class="widget-taglist__link widget__link btn" href=/tags/React/ title=React>React</a>
<a class="widget-taglist__link widget__link btn" href=/tags/Vue/ title=Vue>Vue</a></div></div><div class="widget-social widget"><h4 class="widget-social__title widget__title">Social</h4><div class="widget-social__content widget__content"><div class="widget-social__item widget__item"><a class="widget-social__link widget__link btn" title=GitHub rel="noopener noreferrer" href=https://github.com/Sundin target=_blank><svg class="widget-social__link-icon icon icon-github" width="24" height="24" viewBox="0 0 384 374"><path d="m192 0C85.9.0.0 85.8.0 191.7c0 84.7 55 156.6 131.3 181.9 9.6 1.8 13.1-4.2 13.1-9.2.0-4.6-.2-16.6-.3-32.6-53.4 11.6-64.7-25.7-64.7-25.7-8.7-22.1-21.3-28-21.3-28-17.4-11.9 1.3-11.6 1.3-11.6 19.3 1.4 29.4 19.8 29.4 19.8 17.1 29.3 44.9 20.8 55.9 15.9 1.7-12.4 6.7-20.8 12.2-25.6-42.6-4.8-87.5-21.3-87.5-94.8.0-20.9 7.5-38 19.8-51.4-2-4.9-8.6-24.3 1.9-50.7.0.0 16.1-5.2 52.8 19.7 15.3-4.2 31.7-6.4 48.1-6.5 16.3.1 32.7 2.2 48.1 6.5 36.7-24.8 52.8-19.7 52.8-19.7 10.5 26.4 3.9 45.9 1.9 50.7 12.3 13.4 19.7 30.5 19.7 51.4.0 73.7-44.9 89.9-87.7 94.6 6.9 5.9 13 17.6 13 35.5.0 25.6-.2 46.3-.2 52.6.0 5.1 3.5 11.1 13.2 9.2C329 348.2 384 276.4 384 191.7 384 85.8 298 0 192 0z"/></svg><span>GitHub</span></a></div><div class="widget-social__item widget__item"><a class="widget-social__link widget__link btn" title=Email href=mailto:sundin666@protonmail.com><svg class="widget-social__link-icon icon icon-mail" width="24" height="24" viewBox="0 0 416 288"><path d="m0 16v256 16h16 384 16v-16V16 0h-16H16 0zm347 16-139 92.5L69 32zM199 157.5l9 5.5 9-5.5L384 46v210H32V46z"/></svg><span>sundin666@protonmail.com</span></a></div><div class="widget-social__item widget__item"><a class="widget-social__link widget__link btn" title="Stack Overflow" rel="noopener noreferrer" href=https://stackoverflow.com/users/948942/incinerator target=_blank><svg class="widget-social__link-icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2 1 2h8v11H0V2z"/></svg><span>Stack Overflow</span></a></div><div class="widget-social__item widget__item"><a class="widget-social__link widget__link btn" title="About Me" rel="noopener noreferrer" href=/welcome target=_blank><svg class="widget-social__link-icon icon icon-author" width="16" height="16" viewBox="0 0 12 16"><path d="M6 1c2.2.0 3.5 2 3.5 4.5C9.5 7 8.9 8.2 8 9c2.9.8 4 2.5 4 5v1H0v-1c0-2.5 1.1-4.2 4-5-.9-.8-1.5-2-1.5-3.5C2.5 3 3.8 1 6 1z"/></svg><span>About Me</span></a></div></div></div></aside></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2022 Gustav Sundin.
<span class=footer__copyright-credits>Generated with <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> and <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> theme.</span></div></div></footer></div><script async defer src=/js/menu.js></script></body></html>