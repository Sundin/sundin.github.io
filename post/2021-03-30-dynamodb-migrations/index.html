<!doctype html><html class=no-js lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><title>Migrating data between DynamoDB tables - Master of Software Engineering</title><script>(function(a,b){a[b]=a[b].replace("no-js","js")})(document.documentElement,"className")</script><meta name=description content><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=dns-prefetch href=//fonts.googleapis.com><link rel=dns-prefetch href=//fonts.gstatic.com><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/favicon.ico></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class=logo><a class=logo__link href=/ title="Master of Software Engineering" rel=home><div class="logo__item logo__text"><div class=logo__title>Master of Software Engineering</div></div></a></div><div class=divider></div></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>Migrating data between DynamoDB tables</h1><div class="post__meta meta"><div class="meta__item-author meta__item"><svg class="meta__icon icon icon-author" width="16" height="16" viewBox="0 0 12 16"><path d="M6 1c2.2.0 3.5 2 3.5 4.5C9.5 7 8.9 8.2 8 9c2.9.8 4 2.5 4 5v1H0v-1c0-2.5 1.1-4.2 4-5-.9-.8-1.5-2-1.5-3.5C2.5 3 3.8 1 6 1z"/></svg><span class=meta__text>Gustav Sundin</span></div><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class=meta__text datetime=2021-03-30T10:34:41Z>2021-03-30</time></div><div class="meta__item-categories meta__item"><svg class="meta__icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2 1 2h8v11H0V2z"/></svg><span class=meta__text><a class=meta__link href=/categories/Implementation/ rel=category>Implementation</a>, <a class=meta__link href=/categories/Refactoring/ rel=category>Refactoring</a>, <a class=meta__link href=/categories/AWS/ rel=category>AWS</a></span></div></div></header><div class="content post__content clearfix"><p>When setting up a new DynamoDB table, an important decision is to decide what primary key to use. However, it’s not uncommon to not have the full picture up front and therefore it could be hard to make the right decision beforehand. While the <a href=https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/bp-general-nosql-design.html>official AWS documentation</a> states that <em>“you shouldn’t start designing your schema for DynamoDB until you know the questions it will need to answer”</em>, you often need to experiment to be able to discover what those questions are. Luckily there is an easy approach for how to migrate to a new key schema that we will describe in this blog post.</p><p>In short, the process looks like this:</p><ol><li>Create the target table</li><li>Synchronize incoming changes to the target table using <a href=https://aws.amazon.com/blogs/database/dynamodb-streams-use-cases-and-design-patterns/>DynamoDB Streams</a></li><li>Migrate existing items</li><li>Start reading from the target table</li><li>Start writing to the target table</li><li>Delete the original table</li></ol><p>Changing key schemas is not the only use case for this method. The same approach can also be used to split or merge multiple tables, to manipulate data items, or to get rid of unwanted data. The main advantages of this approach is that it requires no downtime, is easily reversible, and guarantees that no data is lost during the migration process.</p><p>This blog post also comes with a <a href=https://github.com/DeviesDevelopment/dynamodb-migration>companion example repo</a>.</p><p><em>Note that if you’re simply looking for replicating a table over multiple regions, you should have a look at <a href=https://aws.amazon.com/dynamodb/global-tables/>DynamoDB Global Tables</a> instead.</em></p><h2 id=create-target-table>Create target table</h2><p>Before we begin with the actual migration, the target table needs to be in place. Create this table as you normally would, using CloudFormation or elsewise.</p><h2 id=synchronize-changes-using-dynamodb-streams>Synchronize changes using DynamoDB Streams</h2><p>Before we can start using the target table, we need to migrate the data. In our approach we use <a href=https://aws.amazon.com/blogs/database/dynamodb-streams-use-cases-and-design-patterns/>DynamoDB Streams</a>, which is an AWS managed stream of change events that happen to a DynamoDB table. The stream is guaranteed to contain all events in a time-ordered sequence, meaning that we can guarantee that no data loss will occur during the migration.</p><p>To actually migrate data, something needs to be triggered on the change events. For this we use an AWS Lambda function. The function gets the change event as input, and will apply the corresponding change to the target table. For a concrete code example, see <a href=https://github.com/DeviesDevelopment/dynamodb-migration>this repo</a>.</p><p>Note that if any transformation of the item needs to be made, it should happen here in the Lambda function. As stated, this could be anything from one-to-one mapping into a new data format to splitting up the data across multiple target tables.</p><p>An alternative to using DynamoDB Streams is to use <a href=https://aws.amazon.com/datapipeline/>AWS Data Pipeline</a>, which might be better suited for cross account migrations.</p><h2 id=migrate-existing-items>Migrate existing items</h2><p>Now that we have our stream in place, we can be certain that any changes in the original table will be propagated to the target table. We can also leverage the same stream to migrate all the existing data as well. This is as simple as writing a script that makes some update to every item in the original table, meaning that every item will also end up on the DynamoDB stream. This could be as easy as adding some property (such as the “migrate” property in our <a href=https://github.com/DeviesDevelopment/dynamodb-migration>example</a>), which is trimmed off in the Lambda function before the item is written to the target table.</p><h2 id=update-code-to-read-from-target-table>Update code to read from target table</h2><p>At this point we are certain that every item in the original table has been written to the target table, and that any new changes are propagated to the target table. The next step is to update application code to actually read from the target table. There is no need to change all application code at once since both original and target tables will contain the same data (note that there might be a short delay until any written data is available in the target table).
Update code to write to target table</p><p>The next step is to update application code so that it writes to the target table as well. Before we do this we need to be certain that nothing is still reading from the old table. The best way to ensure this is to look at the read capacity metric in the AWS console. Just like with the read operations, there is no need to change everything at once.</p><h2 id=delete-original-table>Delete original table</h2><p>Once all application code is updated to write to the target table, the original table is not used anymore and can be deleted. Before doing so, it could be a good idea to monitor the read and write capacity metrics for a while to make sure you haven’t missed anything.</p><p>The approach described in this blog post is a safe and relatively easy way to migrate data between DynamoDB tables. Thus, it’s not completely true that <em>“you shouldn’t start designing your schema for DynamoDB until you know the questions it will need to answer”</em>. On the contrary, it is actually quite straightforward to make changes to an existing key schema, as long as you do it in a controlled manner. This allows for experimentation and iterative development in any DynamoDB-backed application.</p></div></article></main><div class="authorbox clearfix"><div class=authorbox__header><span class=authorbox__name>About Gustav Sundin</span></div><div class=authorbox__description>My name is Gustav Sundin and I currently work as software engineering consultant at Devies in Gothenburg, Sweden. I also hold a Master’s degree in Software Engineering from Chalmers University. A cool thing with that is that I am allowed to titulate myself “Master of Software Engineering”!</div><br>Follow me with <b><a href=/index.xml>RSS</a></b>.</br><br><i>Did I make a mistake? Please feel free to <b><a href=https://github.com/Sundin/sundin.github.io>issue a pull request to my Github repo</a></b>.</i></br></div><nav class="pager flex"><div class="pager__item pager__item--prev"><a class=pager__link href=/post/2020-11-11-dns-record-types/ rel=prev><span class=pager__subtitle>«&#8201;Previous</span><p class=pager__title>DNS Record Types</p></a></div><div class="pager__item pager__item--next"><a class=pager__link href=/post/2021-04-08-minimize-java-lambda-coldstarts/ rel=next><span class=pager__subtitle>Next&#8201;»</span><p class=pager__title>Minimize Java Lambda Cold Start Times</p></a></div></nav></div><aside class=sidebar><div class="widget-recent widget"><h4 class=widget__title>Recent Posts</h4><div class=widget__content><ul class=widget__list><li class=widget__item><a class=widget__link href=/post/2021-04-14-kubernetes-tutorial/>A short Kubernetes tutorial</a></li><li class=widget__item><a class=widget__link href=/post/2021-04-12-avoid-else/>Avoid using else statements</a></li><li class=widget__item><a class=widget__link href=/post/2021-04-08-minimize-java-lambda-coldstarts/>Minimize Java Lambda Cold Start Times</a></li><li class=widget__item><a class=widget__link href=/post/2021-03-30-dynamodb-migrations/>Migrating data between DynamoDB tables</a></li><li class=widget__item><a class=widget__link href=/post/2020-11-11-dns-record-types/>DNS Record Types</a></li></ul></div></div><div class="widget-categories widget"><h4 class=widget__title>Categories</h4><div class=widget__content><ul class=widget__list><li class=widget__item><a class=widget__link href=/categories/AWS/>AWS</a>&nbsp;
<span class="widget__counter widget__counter--bubble">2</span></li><li class=widget__item><a class=widget__link href=/categories/Agility/>Agility</a>&nbsp;
<span class="widget__counter widget__counter--bubble">4</span></li><li class=widget__item><a class=widget__link href=/categories/Architecture/>Architecture</a>&nbsp;
<span class="widget__counter widget__counter--bubble">1</span></li><li class=widget__item><a class=widget__link href=/categories/DNS/>DNS</a>&nbsp;
<span class="widget__counter widget__counter--bubble">1</span></li><li class=widget__item><a class=widget__link href=/categories/Implementation/>Implementation</a>&nbsp;
<span class="widget__counter widget__counter--bubble">4</span></li><li class=widget__item><a class=widget__link href=/categories/Learning/>Learning</a>&nbsp;
<span class="widget__counter widget__counter--bubble">2</span></li><li class=widget__item><a class=widget__link href=/categories/Mindset/>Mindset</a>&nbsp;
<span class="widget__counter widget__counter--bubble">3</span></li><li class=widget__item><a class=widget__link href=/categories/Patterns/>Patterns</a>&nbsp;
<span class="widget__counter widget__counter--bubble">2</span></li><li class=widget__item><a class=widget__link href=/categories/Refactoring/>Refactoring</a>&nbsp;
<span class="widget__counter widget__counter--bubble">3</span></li><li class=widget__item><a class=widget__link href=/categories/Testing/>Testing</a>&nbsp;
<span class="widget__counter widget__counter--bubble">3</span></li><li class=widget__item><a class=widget__link href=/categories/Workflow/>Workflow</a>&nbsp;
<span class="widget__counter widget__counter--bubble">1</span></li></ul></div></div></aside></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2021 Gustav Sundin.
<span class=footer__copyright-credits>Generated with <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> and <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> theme.</span></div></div></footer></div><script async defer src=/js/menu.js></script></body></html>